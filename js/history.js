// --- Translations ---
const translations = {
    en: {
        nav_title: "Vinland History",
        hero_title: "The Discovery of Vinland",
        hero_subtitle: "Where History Meets Saga",
        btn_explore: "Start Journey",
        timeline_header: "Timeline of Discovery",
        event_982: "Erik the Red is exiled from Iceland and settles in Greenland.",
        event_1000: "Leif Erikson sails west and discovers Helluland, Markland, and Vinland.",
        event_1009: "Thorfinn Karlsefni attempts to establish a permanent settlement.",
        manga_header: "Vinland Saga Parallels",
        char_thorfinn: "Thorfinn Karlsefni",
        desc_thorfinn: "Historically a wealthy explorer. In manga, a warrior seeking peace.",
        char_leif: "Leif Erikson",
        desc_leif: "The discoverer. In anime, a jovial storyteller.",
        char_askeladd: "Askeladd",
        desc_askeladd: "A complex manga character, not directly involved in discovery.",
        map_header: "The Journey Map",
        map_desc: "Follow the path from Iceland to the New World.",
        loc_country: "Canada",
        loc_spot: "L'Anse aux Meadows",
        facts_header: "Did You Know?",
        fact_1: "\"Vinland\" likely means \"Land of Wine\".",
        fact_2: "Conflict with \"Skrælings\" ended the settlement.",
        fact_3: "Discovered by archaeologists in 1960.",
        footer_text: "Made for fans."
    },
    uk: {
        nav_title: "Історія Вінланду",
        hero_title: "Відкриття Вінланду",
        hero_subtitle: "Де історія зустрічається з Сагою",
        btn_explore: "Почати подорож",
        timeline_header: "Хронологія відкриттів",
        event_982: "Ерік Рудий вигнаний з Ісландії та заселяє Гренландію.",
        event_1000: "Лейф Еріксон пливе на захід і відкриває Хеллуланд, Маркланд та Вінланд.",
        event_1009: "Торфінн Карлсефні намагається заснувати постійне поселення.",
        manga_header: "Паралелі з Сагою",
        char_thorfinn: "Торфінн Карлсефні",
        desc_thorfinn: "В історії — заможний дослідник. У манзі — воїн, що шукає миру.",
        char_leif: "Лейф Еріксон",
        desc_leif: "Першовідкривач. В аніме — веселий оповідач.",
        char_askeladd: "Аскеладд",
        desc_askeladd: "Складний персонаж манги, історично не пов'язаний з відкриттям.",
        map_header: "Карта Подорожі",
        map_desc: "Слідуйте шляхом від Ісландії до Нового Світу.",
        loc_country: "Канада",
        loc_spot: "Л'Анс-о-Медоуз",
        facts_header: "Чи знаєте ви?",
        fact_1: "«Вінланд» ймовірно означає «Земля вина».",
        fact_2: "Конфлікт зі скрелінгами поклав край поселенню.",
        fact_3: "Відкрито археологами у 1960 році.",
        footer_text: "Створено для фанатів."
    },
    ru: {
        nav_title: "История Винланда",
        hero_title: "Открытие Винланда",
        hero_subtitle: "Где история встречается с Сагой",
        btn_explore: "Начать путь",
        timeline_header: "Хронология открытий",
        event_982: "Эрик Рыжий изгнан из Исландии и заселяет Гренландию.",
        event_1000: "Лейф Эриксон плывет на запад и открывает Хеллуланд, Маркланд и Винланд.",
        event_1009: "Торфинн Карлсефни пытается основать постоянное поселение.",
        manga_header: "Параллели с Сагой",
        char_thorfinn: "Торфинн Карлсефни",
        desc_thorfinn: "В истории — богатый исследователь. В манге — воин, ищущий мира.",
        char_leif: "Лейф Эриксон",
        desc_leif: "Первооткрыватель. В аниме — веселый рассказчик.",
        char_askeladd: "Аскеладд",
        desc_askeladd: "Сложный персонаж манги, исторически не связан с открытием.",
        map_header: "Карта Путешествия",
        map_desc: "Следуйте по пути от Исландии к Новому Свету.",
        loc_country: "Канада",
        loc_spot: "Л’Анс-о-Медоуз",
        facts_header: "Знаете ли вы?",
        fact_1: "«Винланд», вероятно, означает «Земля вина».",
        fact_2: "Конфликт со скрелингами положил конец поселению.",
        fact_3: "Обнаружено археологами в 1960 году.",
        footer_text: "Сделано для фанатов."
    },
    ja: {
        nav_title: "ヴィンランドの歴史",
        hero_title: "ヴィンランドの発見",
        hero_subtitle: "歴史とサーガが交差する場所",
        btn_explore: "旅を始める",
        timeline_header: "発見の年表",
        event_982: "赤毛のエイリークがアイスランドを追放され、グリーンランドに入植。",
        event_1000: "レイフ・エリクソンが西へ航海し、ヴィンランドを発見。",
        event_1009: "トルフィン・カルルセフニが定住を試みる。",
        manga_header: "ヴィンランド・サガとの対比",
        char_thorfinn: "トルフィン",
        desc_thorfinn: "史実では裕福な探検家。漫画では平和を求める戦士。",
        char_leif: "レイフ・エリクソン",
        desc_leif: "発見者。アニメでは陽気な語り部。",
        char_askeladd: "アシェラッド",
        desc_askeladd: "漫画の主要人物だが、史実の発見には関与していない。",
        map_header: "旅の地図",
        map_desc: "アイスランドから新世界への道を辿る。",
        loc_country: "カナダ",
        loc_spot: "ランス・オ・メドー",
        facts_header: "知っていますか？",
        fact_1: "「ヴィンランド」は「ワインの地」を意味する。",
        fact_2: "スクレリングとの争いで入植は終わった。",
        fact_3: "1960年に遺跡が発見された。",
        footer_text: "ファンのために作成。"
    }
};

document.addEventListener('DOMContentLoaded', () => {
    // --- 1. Language Logic ---
    const langSwitch = document.getElementById('lang-switch');
    
    function setLanguage(lang) {
        if (!translations[lang]) lang = 'en';
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[lang][key]) {
                el.textContent = translations[lang][key];
            }
        });
        localStorage.setItem('selectedLang', lang);
        langSwitch.value = lang;
        // Update map popups if needed (simple reload triggers re-render, 
        // strictly speaking we should update layers, but this is fine for v1)
    }

    const savedLang = localStorage.getItem('selectedLang') || navigator.language.slice(0, 2);
    setLanguage(savedLang);

    langSwitch.addEventListener('change', (e) => setLanguage(e.target.value));

    // --- 2. Theme Logic ---
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = themeToggle.querySelector('i');

    function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        themeIcon.className = theme === 'dark' ? 'bx bx-moon' : 'bx bx-sun';
        localStorage.setItem('theme', theme);
    }

    const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    setTheme(savedTheme);

    themeToggle.addEventListener('click', () => {
        const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        setTheme(newTheme);
    });

    // --- 3. Leaflet Map Logic ---
    // Coordinates
    const iceland = [64.9631, -19.0208];
    const greenland = [61.1275, -45.5459]; // Brattahlid (Erik's settlement)
    const vinland = [51.5953, -55.5312]; // L'Anse aux Meadows

    // Init map focused on North Atlantic
    const map = L.map('vinland-map').setView([58.0, -40.0], 4);

    // Add Tiles (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 10
    }).addTo(map);

    // Custom Icons (Optional, using default for now but colored red in CSS logic usually)
    
    // Add Markers
    L.marker(iceland).addTo(map).bindPopup("<b>Iceland</b><br>Starting Point");
    L.marker(greenland).addTo(map).bindPopup("<b>Greenland</b><br>Erik the Red's Settlement");
    L.marker(vinland).addTo(map).bindPopup("<b>Vinland (Newfoundland)</b><br>L'Anse aux Meadows").openPopup();

    // Draw Route (Polyline)
    const routePoints = [
        iceland,
        [62.0, -35.0], // Waypoint ocean
        greenland,
        [58.0, -55.0], // Labrador Sea
        vinland
    ];

    const routeLine = L.polyline(routePoints, {
        color: '#c0392b', // Viking Red
        weight: 3,
        opacity: 0.8,
        dashArray: '10, 10', // Dashed line like a map trail
        lineCap: 'round'
    }).addTo(map);

    // Zoom to fit route
    map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});
});